@{
    ViewData["Title"] = "Teacher Attendance";
    var teacher = ViewBag.Teacher;
    var attendances = ViewBag.Attendances as List<ClassClockPlus.Models.Attendance>;
    var today = DateTime.UtcNow.Date;
}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Attendance - @teacher?.FullName</h2>
        <form asp-controller="Account" asp-action="Logout" method="post">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Parent</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in teacher!.Students)
                {
                    var att = attendances!.FirstOrDefault(a => a.StudentID == student.StudentID);
                    var status = att?.Status ?? "Pending";
                    <tr>
                        <td>@student.FullName</td>
                        <td>@student.ClassName</td>
                        <td>@student.Parent?.User?.FullName</td>
                        <td>
                            <select class="form-select attendance-select" data-id="@student.StudentID">
                            
                            <option value="Present" selected="@(status == "Present" ? "selected" : null)">Present</option>
                            <option value="Absent" selected="@(status == "Absent" ? "selected" : null)">Absent</option>
                            <option value="Late" selected="@(status == "Late" ? "selected" : null)">Late</option>

                            </select>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script>
document.querySelectorAll(".attendance-select").forEach(select => {
    select.addEventListener("change", async () => {
        const studentId = select.dataset.id;
        const status = select.value;

        const res = await fetch('/Teacher/MarkAttendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId, status })
        });

        const data = await res.json();
        if (!data.success) alert(data.message || 'Error saving attendance');
    });
});
</script>
}
