@{
    Layout = "_Layout";
    var students = ViewBag.Students as IEnumerable<dynamic>;
    var parents = ViewBag.Parents as IEnumerable<dynamic>;
    var teacher = ViewBag.Teacher;
}

<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .container {
        animation: fadeIn 0.6s ease-out;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Header Styling */
    .header-wrapper {
        background: white;
        border-radius: 20px;
        padding: 1.5rem 2rem;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .fw-bold {
        font-size: 1.75rem;
        letter-spacing: -0.5px;
    }

    #liveClock {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 0.6rem 1.2rem;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    }

    /* Button Enhancements */
    .btn {
        border-radius: 12px;
        font-weight: 600;
        padding: 0.65rem 1.3rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-width: 2px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .btn-sm {
        padding: 0.45rem 1rem;
        font-size: 0.875rem;
    }

    /* Card Enhancements */
    .card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .card:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        transform: translateY(-5px);
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        font-weight: 700;
        font-size: 1.05rem;
        padding: 1.2rem 1.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Form Styling */
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.7rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    /* Table Enhancements */
    .table-responsive {
        border-radius: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table {
        margin-bottom: 0;
    }

    .table-dark {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    }

    .table-dark th {
        border: none;
        padding: 1.1rem 1rem;
        font-weight: 600;
        white-space: nowrap;
        font-size: 0.9rem;
    }

    .table-hover tbody tr {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .table-hover tbody tr:hover {
        background: rgba(13, 110, 253, 0.05);
        transform: scale(1.005);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .table td {
        vertical-align: middle;
        padding: 1.1rem 1rem;
    }

    .rounded-circle {
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .rounded-circle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* Checkbox Styling */
    .form-check-input {
        width: 22px;
        height: 22px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-check-input:hover {
        transform: scale(1.15);
    }

    /* Modal Enhancements */
    .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 2px solid #e9ecef;
        padding: 1.25rem;
    }

    /* Toast Enhancements */
    .toast {
        border-radius: 12px;
        border: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 320px;
    }

    .toast-body {
        padding: 1rem 1.25rem;
        font-weight: 600;
    }

    /* Stat Card Animation */
    .stat-card-animate {
        animation: slideUp 0.5s ease-out;
    }

    @@keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .container {
            padding: 1rem 0.75rem;
        }

        .header-wrapper {
            padding: 1.25rem;
            border-radius: 16px;
        }

        .fw-bold {
            font-size: 1.35rem;
        }

        #liveClock {
            width: 100%;
            text-align: center;
            margin-top: 0.75rem;
        }

        .btn {
            width: 100%;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .card {
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1rem;
            font-size: 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        /* Mobile Table Cards */
        .table-responsive {
            border-radius: 0;
            overflow: visible;
        }

        .table {
            display: block;
        }

        .table thead {
            display: none;
        }

        .table tbody {
            display: block;
        }

        .table tbody tr {
            display: block;
            margin-bottom: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 1.25rem;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .table tbody tr:hover {
            transform: none;
        }

        .table tbody td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border: none;
            text-align: right;
        }

        .table tbody td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #6c757d;
            text-align: left;
            flex: 1;
        }

        .table tbody td:first-child {
            justify-content: center;
            padding-bottom: 1rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
        }

        .table tbody td:first-child::before {
            display: none;
        }

        .rounded-circle {
            width: 75px !important;
            height: 75px !important;
        }

        .btn-sm {
            width: auto;
            padding: 0.5rem 1rem;
        }
    }

    @@media (max-width: 576px) {
        .fw-bold {
            font-size: 1.15rem;
        }

        .card-header {
            font-size: 0.95rem;
        }

        .table tbody td {
            font-size: 0.9rem;
        }

        .rounded-circle {
            width: 65px !important;
            height: 65px !important;
        }
    }

    /* Custom Scrollbar */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f3f5;
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, #0d6efd 0%, #0a58ca 100%);
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(90deg, #0a58ca 0%, #084298 100%);
    }
</style>

<div class="container py-4">
    <div class="header-wrapper">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <h2 class="fw-bold text-primary mb-3 mb-md-0">
                <i class="bi bi-mortarboard-fill me-2"></i>Class: @teacher.ClassName
            </h2>
            <div class="d-flex flex-column flex-md-row align-items-center gap-2 w-100 w-md-auto">
                <a href="/Report/Create" class="btn btn-outline-primary">
                    <i class="bi bi-journal-text me-1"></i> Create Report
                </a>
                <h5 class="text-muted mb-0" id="liveClock"></h5>
                <form asp-controller="Account" asp-action="Logout" method="post" class="m-0 w-100 w-md-auto">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-box-arrow-right me-1"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <div class="stat-card-animate">
                <div class="card border-0 shadow-sm bg-primary text-white text-center p-3">
                    <h6><i class="bi bi-people-fill me-2"></i>Total Students</h6>
                    <h2 class="mb-0 fw-bold">@((students?.Count() ?? 0))</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card-animate" style="animation-delay: 0.1s;">
                <div class="card border-0 shadow-sm bg-success text-white text-center p-3">
                    <h6><i class="bi bi-person-hearts me-2"></i>Total Parents</h6>
                    <h2 class="mb-0 fw-bold">@((parents?.Count() ?? 0))</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header">
            <i class="bi bi-person-plus-fill me-2"></i>Add New Student
        </div>
        <div class="card-body">
            <form id="studentForm" enctype="multipart/form-data">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold">Full Name</label>
                        <input type="text" name="studentName" class="form-control" placeholder="Enter name" required />
                    </div>
                    <div class="col-12 col-md-2">
                        <label class="form-label fw-semibold">Gender</label>
                        <select name="gender" class="form-select" required>
                            <option value="">Select</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold">Parent</label>
                        <select name="parentId" class="form-select" required>
                            <option value="">Select Parent</option>
                            @foreach (var p in parents ?? Enumerable.Empty<dynamic>())
                            {
                                <option value="@p.ParentID">@p.User?.FullName (@p.User?.Email)</option>
                            }
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold">Photo</label>
                        <input type="file" name="imageFile" class="form-control" />
                    </div>
                    <div class="col-12 col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header">
            <i class="bi bi-list-stars me-2"></i>Student List
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="studentsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Class</th>
                            <th>Parent</th>
                            <th>Clock</th>
                            <th>Attendance</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in students ?? Enumerable.Empty<dynamic>())
                        {
                            <tr data-id="@s.StudentID">
                                <td data-label="Photo">
                                    <img src="@(!string.IsNullOrEmpty(s.ImagePath) ? s.ImagePath : "/images/default-user.png")"
                                         class="rounded-circle border" style="width:50px;height:50px;object-fit:cover;" 
                                         alt="@s.FullName">
                                </td>
                                <td data-label="Name"><strong>@s.FullName</strong></td>
                                <td data-label="Gender">@s.Gender</td>
                                <td data-label="Class">@s.ClassName</td>
                                <td data-label="Parent">@(s.Parent?.User?.FullName ?? "N/A")</td>
                                <td data-label="Clock">
                                    <button class="btn btn-sm @(s.IsClockedIn ? "btn-danger" : "btn-success") toggleClockBtn"
                                            data-id="@s.StudentID">
                                        <i class="bi bi-clock me-1"></i>@(s.IsClockedIn ? "Clock Out" : "Clock In")
                                    </button>
                                </td>
                                <td data-label="Attendance" class="text-center">
                                    <div class="d-flex align-items-center gap-2 justify-content-end justify-content-md-center">
                                        <input type="checkbox" class="form-check-input attendance-check"
                                               id="att_@s.StudentID" data-id="@s.StudentID" />
                                        <label for="att_@s.StudentID" class="mb-0 text-danger">Absent</label>
                                    </div>
                                </td>
                                <td data-label="Action">
                                    <button class="btn btn-sm btn-outline-danger deleteStudentBtn"
                                            data-id="@s.StudentID" aria-label="Delete student">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <button id="saveAttendanceBtn" class="btn btn-primary mt-3">
                <i class="bi bi-check-circle me-1"></i>Save Attendance
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentModalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmLabel"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
        <p class="fs-5 mt-3 mb-0">Are you sure you want to delete this student?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger px-4">
            <i class="bi bi-trash me-1"></i>Yes, Delete
        </button>
      </div>
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="appToastBody"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function showToast(message, isSuccess = true, delay = 3000) {
        const toastEl = document.getElementById('appToast');
        document.getElementById('appToastBody').textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
        if (isSuccess) {
            toastEl.classList.add('bg-success', 'text-white');
        } else {
            toastEl.classList.add('bg-danger', 'text-white');
        }
        const toast = new bootstrap.Toast(toastEl, { delay });
        toast.show();
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    document.getElementById("studentForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/Teacher/SaveStudent', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                showToast('✅ Student added!', true);
                setTimeout(() => location.reload(), 900);
            } else {
                showToast(data.message || 'Error adding student', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error while adding student', false);
        }
    });

    document.addEventListener("click", async (e) => {
        const clockBtn = e.target.closest(".toggleClockBtn");
        if (clockBtn) {
            const id = clockBtn.dataset.id;
            try {
                const res = await fetch('/Teacher/ToggleClock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId: id })
                });
                const data = await res.json();
                if (data.success) {
                    clockBtn.classList.toggle("btn-success");
                    clockBtn.classList.toggle("btn-danger");
                    clockBtn.innerHTML = data.isClockedIn 
                        ? '<i class="bi bi-clock me-1"></i>Clock Out' 
                        : '<i class="bi bi-clock me-1"></i>Clock In';
                    showToast(data.isClockedIn ? '✅ Clocked in' : '✅ Clocked out', true);
                } else {
                    showToast(data.message || 'Error toggling clock', false);
                }
            } catch (err) {
                console.error(err);
                showToast('Network error toggling clock', false);
            }
            return;
        }

        const delBtn = e.target.closest(".deleteStudentBtn");
        if (delBtn) {
            window.__deleteStudentId = delBtn.dataset.id;
            const delModalEl = document.getElementById("deleteConfirmModal");
            const delModal = new bootstrap.Modal(delModalEl);
            delModal.show();
            return;
        }
    });

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
        const id = window.__deleteStudentId;
        if (!id) return;
        try {
            const res = await fetch(`/Teacher/DeleteStudent?id=${id}`, { method: 'DELETE' });
            const data = await res.json();

            const delModalEl = document.getElementById("deleteConfirmModal");
            const modalInstance = bootstrap.Modal.getInstance(delModalEl) || new bootstrap.Modal(delModalEl);
            modalInstance.hide();

            if (data.success) {
                const row = document.querySelector(`tr[data-id='${id}']`);
                if (row) {
                    row.style.transition = "opacity 0.35s ease, height 0.35s ease, margin 0.35s ease";
                    row.style.opacity = "0";
                    row.style.height = "0";
                    row.style.margin = "0";
                    setTimeout(() => row.remove(), 360);
                }
                showToast('✅ Student deleted', true);
            } else {
                showToast(data.message || 'Error deleting student', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error deleting student', false);
        } finally {
            window.__deleteStudentId = null;
        }
    });

    document.getElementById("saveAttendanceBtn").addEventListener("click", async () => {
        const attendanceData = Array.from(document.querySelectorAll(".attendance-check")).map(chk => ({
            studentId: chk.dataset.id,
            status: chk.checked ? "Present" : "Absent"
        }));
        try {
            const res = await fetch('/Teacher/SaveAttendanceBatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendanceData)
            });
            const data = await res.json();
            if (data.success) {
                showToast('✅ Attendance saved!', true);
            } else {
                showToast(data.message || 'Error saving attendance', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error saving attendance', false);
        }
    });

    document.addEventListener("change", (e) => {
        const chk = e.target.closest(".attendance-check");
        if (chk) {
            const label = chk.nextElementSibling;
            if (chk.checked) {
                label.textContent = "Present";
                label.classList.remove("text-danger");
                label.classList.add("text-success");
            } else {
                label.textContent = "Absent";
                label.classList.remove("text-success");
                label.classList.add("text-danger");
            }
        }
    });

    document.querySelectorAll("#studentsTable tbody tr").forEach(row => {
        row.addEventListener("click", async (e) => {
            if (e.target.closest(".toggleClockBtn") || e.target.closest(".deleteStudentBtn") || e.target.closest(".attendance-check")) return;
            const id = row.dataset.id;
            try {
                const res = await fetch(`/Teacher/GetStudentDetails?id=${id}`);
                if (!res.ok) {
                    showToast('Error loading student details', false);
                    return;
                }
                const html = await res.text();
                document.getElementById("studentModalBody").innerHTML = html;
                const stModal = new bootstrap.Modal(document.getElementById("studentModal"));
                stModal.show();
            } catch (err) {
                console.error(err);
                showToast('Network error loading details', false);
            }
        });
    });

</script>
}