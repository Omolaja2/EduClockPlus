@{
    Layout = "_Layout";
    var students = ViewBag.Students as IEnumerable<dynamic>;
    var parents = ViewBag.Parents as IEnumerable<dynamic>;
    var teacher = ViewBag.Teacher;
}

<div class="container py-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-3 mb-md-0">
            Class: @teacher.ClassName
        </h2>
        <div class="d-flex align-items-center gap-2">
            <a href="/Report/Create" class="btn btn-outline-primary">
                <i class="bi bi-journal-text me-1"></i> Create Report
            </a>
            <h5 class="text-muted mb-0" id="liveClock"></h5>
            <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-box-arrow-right me-1"></i> Logout
                </button>
            </form>
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm bg-primary text-white text-center p-3">
                <h6>Total Students</h6>
                <h2>@((students?.Count() ?? 0))</h2>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm bg-success text-white text-center p-3">
                <h6>Total Parents</h6>
                <h2>@((parents?.Count() ?? 0))</h2>
            </div>
        </div>
    </div>


    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light fw-semibold">
            + Add New Student
        </div>
        <div class="card-body">
            <form id="studentForm" enctype="multipart/form-data">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Full Name</label>
                        <input type="text" name="studentName" class="form-control" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Gender</label>
                        <select name="gender" class="form-select" required>
                            <option value="">Select</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Parent</label>
                        <select name="parentId" class="form-select" required>
                            <option value="">Select Parent</option>
                            @foreach (var p in parents ?? Enumerable.Empty<dynamic>())
                            {
                                <option value="@p.ParentID">@p.User?.FullName (@p.User?.Email)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Photo</label>
                        <input type="file" name="imageFile" class="form-control" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">+ Add</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-light fw-semibold">
            Student List
        </div>
        <div class="card-body table-responsive">
            <table class="table table-hover align-middle" id="studentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Class</th>
                        <th>Parent</th>
                        <th>Clock</th>
                        <th>Attendance</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in students ?? Enumerable.Empty<dynamic>())
                    {
                        <tr data-id="@s.StudentID">
                            <td>
                                <img src="@(!string.IsNullOrEmpty(s.ImagePath) ? s.ImagePath : "/images/default-user.png")"
                                     class="rounded-circle border" style="width:50px;height:50px;object-fit:cover;">
                            </td>
                            <td>@s.FullName</td>
                            <td>@s.Gender</td>
                            <td>@s.ClassName</td>
                            <td>@(s.Parent?.User?.FullName ?? "N/A")</td>
                            <td>
                                <button class="btn btn-sm @(s.IsClockedIn ? "btn-danger" : "btn-success") toggleClockBtn"
                                        data-id="@s.StudentID">
                                    @(s.IsClockedIn ? "Clock Out" : "Clock In")
                                </button>
                            </td>
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input attendance-check"
                                       id="att_@s.StudentID" data-id="@s.StudentID" />
                                <label for="att_@s.StudentID">Absent</label>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger deleteStudentBtn"
                                        data-id="@s.StudentID" aria-label="Delete student">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <button id="saveAttendanceBtn" class="btn btn-primary mt-3">Save Attendance</button>
        </div>
    </div>
</div>


<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentModalBody"></div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmLabel"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="fs-5">Are you sure you want to delete this student?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger px-4">Yes, Delete</button>
      </div>
    </div>
  </div>
</div>




<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="appToastBody"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function showToast(message, isSuccess = true, delay = 3000) {
        const toastEl = document.getElementById('appToast');
        document.getElementById('appToastBody').textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
        if (isSuccess) {
            toastEl.classList.add('bg-success', 'text-white');
        } else {
            toastEl.classList.add('bg-danger', 'text-white');
        }
        const toast = new bootstrap.Toast(toastEl, { delay });
        toast.show();
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    document.getElementById("studentForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/Teacher/SaveStudent', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                showToast('✅ Student added!', true);
                setTimeout(() => location.reload(), 900);
            } else {
                showToast(data.message || 'Error adding student', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error while adding student', false);
        }
    });

    document.addEventListener("click", async (e) => {
        const clockBtn = e.target.closest(".toggleClockBtn");
        if (clockBtn) {
            const id = clockBtn.dataset.id;
            try {
                const res = await fetch('/Teacher/ToggleClock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId: id })
                });
                const data = await res.json();
                if (data.success) {
                    clockBtn.classList.toggle("btn-success");
                    clockBtn.classList.toggle("btn-danger");
                    clockBtn.textContent = data.isClockedIn ? "Clock Out" : "Clock In";
                    showToast(data.isClockedIn ? '✅ Clocked in' : '✅ Clocked out', true);
                } else {
                    showToast(data.message || 'Error toggling clock', false);
                }
            } catch (err) {
                console.error(err);
                showToast('Network error toggling clock', false);
            }
            return;
        }

        const delBtn = e.target.closest(".deleteStudentBtn");
        if (delBtn) {
            window.__deleteStudentId = delBtn.dataset.id;
            const delModalEl = document.getElementById("deleteConfirmModal");
            const delModal = new bootstrap.Modal(delModalEl);
            delModal.show();
            return;
        }
    });

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
        const id = window.__deleteStudentId;
        if (!id) return;
        try {
            const res = await fetch(`/Teacher/DeleteStudent?id=${id}`, { method: 'DELETE' });
            const data = await res.json();

            const delModalEl = document.getElementById("deleteConfirmModal");
            const modalInstance = bootstrap.Modal.getInstance(delModalEl) || new bootstrap.Modal(delModalEl);
            modalInstance.hide();

            if (data.success) {
                const row = document.querySelector(`tr[data-id='${id}']`);
                if (row) {
                    row.style.transition = "opacity 0.35s ease, height 0.35s ease, margin 0.35s ease";
                    row.style.opacity = "0";
                    row.style.height = "0";
                    row.style.margin = "0";
                    setTimeout(() => row.remove(), 360);
                }
                showToast('✅ Student deleted', true);
            } else {
                showToast(data.message || 'Error deleting student', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error deleting student', false);
        } finally {
            window.__deleteStudentId = null;
        }
    });

    document.getElementById("saveAttendanceBtn").addEventListener("click", async () => {
        const attendanceData = Array.from(document.querySelectorAll(".attendance-check")).map(chk => ({
            studentId: chk.dataset.id,
            status: chk.checked ? "Present" : "Absent"
        }));
        try {
            const res = await fetch('/Teacher/SaveAttendanceBatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attendanceData)
            });
            const data = await res.json();
            if (data.success) {
                showToast('✅ Attendance saved!', true);
            } else {
                showToast(data.message || 'Error saving attendance', false);
            }
        } catch (err) {
            console.error(err);
            showToast('Network error saving attendance', false);
        }
    });

    document.addEventListener("change", (e) => {
        const chk = e.target.closest(".attendance-check");
        if (chk) {
            const label = chk.nextElementSibling;
            if (chk.checked) {
                label.textContent = "Present";
                label.classList.remove("text-danger");
                label.classList.add("text-success");
            } else {
                label.textContent = "Absent";
                label.classList.remove("text-success");
                label.classList.add("text-danger");
            }
        }
    });

    document.querySelectorAll("#studentsTable tbody tr").forEach(row => {
        row.addEventListener("click", async (e) => {
            if (e.target.closest(".toggleClockBtn") || e.target.closest(".deleteStudentBtn") || e.target.closest(".attendance-check")) return;
            const id = row.dataset.id;
            try {
                const res = await fetch(`/Teacher/GetStudentDetails?id=${id}`);
                if (!res.ok) {
                    showToast('Error loading student details', false);
                    return;
                }
                const html = await res.text();
                document.getElementById("studentModalBody").innerHTML = html;
                const stModal = new bootstrap.Modal(document.getElementById("studentModal"));
                stModal.show();
            } catch (err) {
                console.error(err);
                showToast('Network error loading details', false);
            }
        });
    });

</script>
}
