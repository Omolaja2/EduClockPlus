@{
    ViewData["Title"] = "Create Report Card";
    var students = ViewBag.Students as List<ClassClockPlus.Models.Student>;
}

<div class="container py-5">
    <div class="d-flex justify-content-between mb-4">
        <a asp-controller="Teacher" asp-action="Dashboard" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> < Back
        </a>
    </div>

<div class="container py-5">
    <h3 class="mb-4 text-primary fw-bold">Create Report Card</h3>

    <form id="reportForm">
        <div class="mb-3">
            <label>Student</label>
            <select name="studentId" class="form-select" required>
                <option value="">Select Student</option>
                @foreach (var s in students!)
                {
                    <option value="@s.StudentID">@s.FullName</option>
                }
            </select>
        </div>

        <div class="mb-3">
            <label>Term</label>
            <select name="term" class="form-select" required>
                <option>First Term</option>
                <option>Second Term</option>
                <option>Third Term</option>
            </select>
        </div>

        <div id="subjectsContainer" class="mb-3">
            <label>Subjects & Scores</label>
            <div class="d-flex gap-2 mb-2">
                <input type="text" name="subjects" placeholder="Subject" class="form-control" required />
                <input type="number" name="scores" placeholder="Score" class="form-control" required />
            </div>
        </div>

        <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="addSubject">+ Add Subject</button>

        <div class="mb-3">
            <label>Comments</label>
            <textarea name="comments" class="form-control" rows="3"></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100">
            <span id="btnText">Save & Send Report</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
        </button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.getElementById('addSubject').addEventListener('click', () => {
        const container = document.getElementById('subjectsContainer');
        const div = document.createElement('div');
        div.className = 'd-flex gap-2 mb-2';
        div.innerHTML = `
            <input type="text" name="subjects" placeholder="Subject" class="form-control" required />
            <input type="number" name="scores" placeholder="Score" class="form-control" required />
        `;
        container.appendChild(div);
    });

    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        btn.disabled = true;
        btnText.textContent = "Sending...";
        btnSpinner.classList.remove('d-none');
        const formData = new FormData(form);

        try {
            const response = await fetch('@Url.Action("Create", "Report")', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Report Sent!',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                form.reset();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message || 'Something went wrong!'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Failed to send report. Please try again.'
            });
        } finally {
            btn.disabled = false;
            btnText.textContent = "Save & Send Report";
            btnSpinner.classList.add('d-none');
        }
    });
</script>
